# 系统架构文档

## 1. 项目概述

**IBVS_Teleoperation_UR** 是一个基于视觉伺服的机器人遥操作系统，专为 Universal Robots 机器人设计，集成了实时目标检测、视觉伺服控制和遥操作功能。

### 1.1 核心功能
- **视觉伺服控制 (IBVS)**：基于 AprilTag 的图像视觉伺服
- **机器人遥操作**：通过键盘控制机器人运动
- **YOLO 目标检测**：基于 TensorRT 的实时目标检测
- **相机接口**：RealSense D405 相机数据获取

## 2. 系统架构

### 2.1 模块划分

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                                  系统控制器                                 │
│                                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  │  视觉伺服   │  │  遥操作     │  │  YOLO检测   │  │  相机接口   │  │  目标检测   │
│  │  控制模块   │  │  控制模块   │  │  控制模块   │  │  控制模块   │  │  控制模块   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                               底层硬件接口                                   │
│                                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  Universal  │  │ RealSense   │  │  CUDA      │  │  TensorRT   │          │
│  │  Robots     │  │  D405       │  │  加速      │  │  推理引擎   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘          │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 核心模块详解

#### 2.2.1 系统控制器 (SystemController)
- **功能**：协调各个模块的工作，实现状态管理和任务调度
- **状态机**：
  - `STATE_IBVS`：视觉伺服状态
  - `STATE_WAIT_SELECT`：等待选择状态
  - `STATE_APPROACH`：接近目标状态
  - `STATE_TELEOP`：遥操作状态
- **实现文件**：`src/SystemController.cpp`

#### 2.2.2 视觉伺服控制 (IBVS)
- **功能**：基于图像的视觉伺服控制，通过 AprilTag 实现目标追踪
- **技术特点**：
  - Eye-in-Hand 相机配置
  - 自适应增益控制
  - 实时错误计算和速度控制
- **实现文件**：`src/SystemController.cpp` 中的 `process_ibvs()` 方法

#### 2.2.3 机器人遥操作 (RobotTeleoperation)
- **功能**：通过键盘控制机器人运动
- **技术特点**：
  - 支持平移和旋转控制
  - 精细/快速控制模式切换
  - 急停功能
- **实现文件**：`src/RobotTeleoperation.cpp`

#### 2.2.4 YOLO 目标检测 (TensorRT_detection)
- **功能**：基于 TensorRT 的实时目标检测
- **技术特点**：
  - GPU 加速推理
  - 支持多种目标类别
  - 实时检测结果绘制
- **实现文件**：`src/TensorRT_detection.cpp`

#### 2.2.5 相机接口
- **功能**：RealSense D405 相机数据获取
- **技术特点**：
  - 支持 RGB 图像获取
  - 支持深度图像获取
  - 相机参数自动校准
- **实现**：通过 VISP 的 `vpRealSense2` 类

## 3. 数据流

### 3.1 视觉伺服数据流

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  相机获取   │────>│  AprilTag   │────>│  视觉伺服   │────>│  机器人     │
│  图像数据   │     │  目标检测   │     │  计算速度   │     │  执行运动   │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

### 3.2 遥操作数据流

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  键盘输入   │────>│  遥操作     │────>│  速度控制   │────>│  机器人     │
│  控制指令   │     │  解析指令   │     │  计算速度   │     │  执行运动   │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

### 3.3 YOLO 检测数据流

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  相机获取   │────>│  图像预处理  │────>│  TensorRT   │────>│  结果绘制   │
│  RGB图像    │     │  和转换     │     │  模型推理   │     │  到图像上   │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

## 4. 技术依赖

### 4.1 核心依赖
- **VISP 3.7.1**：核心视觉库，提供相机接口、目标检测、视觉伺服等功能
- **OpenCV**：图像处理库，用于图像显示和处理
- **Eigen3**：线性代数库，用于矩阵运算
- **RealSense SDK**：通过 VISP 间接依赖，用于 D405 相机接口

### 4.2 可选依赖
- **CUDA**：GPU 加速库，用于 TensorRT 推理
- **TensorRT**：深度学习推理引擎，用于 YOLO 目标检测

## 5. 系统配置

### 5.1 配置参数
- **相机参数**：分辨率、帧率等
- **AprilTag 参数**：标签大小、检测精度等
- **视觉伺服参数**：增益、控制模式等
- **遥操作参数**：控制速度、模式切换等
- **YOLO 检测参数**：模型路径、置信度阈值等

### 5.2 配置文件
配置参数通过 `AppConfig` 结构体在代码中设置，位于 `include/AppConfig.h` 文件中。

## 6. 性能分析

### 6.1 实时性能
- **视觉伺服**：约 30Hz
- **YOLO 检测**：取决于 GPU 性能，最高可达 60Hz
- **遥操作**：约 100Hz

### 6.2 资源占用
- **CPU**：主要用于图像预处理和控制计算
- **GPU**：主要用于 TensorRT 推理（可选）
- **内存**：取决于模型大小和图像分辨率

## 7. 扩展接口

### 7.1 模块扩展
- **新的目标检测算法**：通过扩展 `TensorRT_detection` 类
- **新的相机接口**：通过替换 `vpRealSense2` 实例
- **新的机器人接口**：通过替换 `vpRobotUniversalRobots` 实例

### 7.2 功能扩展
- **路径规划**：添加路径规划模块
- **碰撞检测**：添加碰撞检测模块
- **用户界面**：添加图形化用户界面

## 8. 系统安全

### 8.1 安全措施
- **急停功能**：遥操作模块中的急停功能
- **速度限制**：机器人速度限制
- **错误处理**：异常情况的错误处理

### 8.2 安全建议
- **使用前测试**：在安全环境中测试系统
- **定期校准**：定期校准相机和机器人
- **监控系统**：实时监控系统状态

## 9. 总结

**IBVS_Teleoperation_UR** 系统采用模块化设计，具有良好的扩展性和可维护性。通过集成视觉伺服控制、遥操作和目标检测功能，为机器人操作提供了直观、高效的控制方式。

系统架构设计考虑了实时性能和可靠性，适合在工业环境中使用。同时，通过可选的 TensorRT 加速，提供了高性能的目标检测能力，为复杂场景下的机器人操作提供了更多可能性。
