# YOLO 检测器测试程序使用指南

## 1. 测试程序概述

本测试程序用于评估测试 YOLO 目标检测器的功能，支持以下功能：

- **多输入源支持**：相机、图像文件、视频文件
- **性能统计**：帧率(FPS)、处理时间
- **结果可视化**：实时显示检测结果和性能统计
- **结果保存**：保存检测结果和性能数据
- **灵活配置**：通过命令行参数进行详细配置

## 2. 构建测试程序

### 2.1 前置条件

- CMake 3.10+
- C++17 兼容编译器
- VISP 3.7.1+
- OpenCV 4.0+
- CUDA (可选，用于 GPU 加速)
- TensorRT (可选，用于 YOLO 检测)

### 2.2 构建步骤

```bash
# 创建构建目录
mkdir -p build/test

# 进入构建目录
cd build/test

# 配置 CMake
cmake ../../test

# 编译
make
```

## 3. 使用测试程序

### 3.1 命令行参数

```bash
./test_yolo_detector [选项]

选项：
  --model, -m <路径>    YOLO 模型路径
  --source, -s <类型>   输入源 (camera/image/video)
  --input, -i <路径>    输入文件路径
  --confidence, -c <值> 置信度阈值
  --nms, -n <值>       NMS 阈值
  --save, -S            保存检测结果
  --output, -o <路径>   输出目录
  --stats, -t           显示性能统计
  --width, -w <值>     相机宽度
  --height, -h <值>    相机高度
```

### 3.2 使用脚本运行测试

为了方便使用，提供了 `run_test.sh` 脚本：

```bash
# 相机测试
./run_test.sh camera <模型路径>

# 图像测试
./run_test.sh image <模型路径> <图像路径>

# 视频测试
./run_test.sh video <模型路径> <视频路径>
```

**示例**：

```bash
# 相机测试
./run_test.sh camera ../models/yolo_model.trt

# 图像测试
./run_test.sh image ../models/yolo_model.trt ../test_data/test_image.jpg

# 视频测试
./run_test.sh video ../models/yolo_model.trt ../test_data/test_video.mp4
```

## 4. 测试结果解释

### 4.1 实时显示

运行测试时，会显示以下信息：

- **FPS**：每秒处理的帧数
- **平均处理时间**：每帧的平均处理时间（毫秒）
- **检测到的目标数**：当前帧检测到的目标数量
- **处理时间**：当前帧的处理时间（毫秒）
- **检测框**：绿色矩形框标记检测到的目标
- **类别标签**：显示目标类别和置信度

### 4.2 保存的结果

测试结果会保存到 `results/` 目录：

- **frame_<索引>.jpg**：带有检测框的图像
- **detections_<索引>.txt**：检测结果文本文件，包含：
  - 处理时间
  - 检测到的目标数量
  - 每个目标的详细信息（类别ID、置信度、位置、尺寸、类别名称）

### 4.3 性能统计

测试完成后，会显示以下统计信息：

- **总帧数**：处理的总帧数
- **平均 FPS**：整个测试过程的平均帧率
- **平均处理时间**：整个测试过程的平均处理时间

## 5. 测试场景建议

### 5.1 相机测试

- **目的**：测试实时性能和相机集成
- **使用方法**：直接运行 `./run_test.sh camera <模型路径>`
- **观察重点**：实时帧率、检测稳定性、响应速度

### 5.2 图像测试

- **目的**：测试静态场景下的检测精度
- **使用方法**：准备包含目标的测试图像，运行 `./run_test.sh image <模型路径> <图像路径>`
- **观察重点**：检测准确率、边界框精度、类别识别

### 5.3 视频测试

- **目的**：测试动态场景下的检测性能
- **使用方法**：准备包含目标运动的测试视频，运行 `./run_test.sh video <模型路径> <视频路径>`
- **观察重点**：帧率稳定性、目标跟踪效果、处理延迟

## 6. 性能评估指标

### 6.1 速度指标

- **FPS**：理想值 > 30 FPS（实时应用）
- **处理时间**：理想值 < 33 ms（对应 30 FPS）

### 6.2 精度指标

- **准确率**：正确检测的目标数 / 实际目标数
- **召回率**：正确检测的目标数 / 检测到的目标数
- **mAP**：平均精度均值（需要标注数据）

### 6.3 稳定性指标

- **帧率波动**：测试过程中 FPS 的标准差
- **检测一致性**：同一目标在连续帧中的检测稳定性

## 7. 故障排除

### 7.1 常见错误

| 错误信息 | 可能原因 | 解决方案 |
|---------|---------|---------|
| 模型文件未找到 | 模型路径错误 | 检查模型文件路径是否正确 |
| CUDA 未找到 | 未安装 CUDA 或路径未配置 | 安装 CUDA 并配置环境变量 |
| TensorRT 未找到 | 未安装 TensorRT 或路径未配置 | 安装 TensorRT 并配置环境变量 |
| 相机初始化失败 | 相机未连接或驱动问题 | 检查相机连接，安装正确驱动 |
| 输入文件未找到 | 图像/视频文件路径错误 | 检查输入文件路径是否正确 |

### 7.2 性能优化建议

- **使用 GPU 加速**：安装 CUDA 和 TensorRT
- **调整输入分辨率**：降低分辨率可以提高帧率
- **调整置信度阈值**：提高阈值可以减少误检，但可能降低召回率
- **使用量化模型**：TensorRT 支持 INT8 量化，可以进一步提高性能

## 8. 测试数据准备

### 8.1 测试图像

准备包含以下内容的测试图像：

- 不同大小的目标
- 不同角度的目标
- 不同光照条件下的目标
- 包含干扰物的场景

### 8.2 测试视频

准备包含以下内容的测试视频：

- 目标静止的场景
- 目标缓慢移动的场景
- 目标快速移动的场景
- 摄像头移动的场景

## 9. 测试结果分析示例

### 9.1 测试输出示例

```
=== YOLO 检测器测试程序 ===
模型路径: ../models/yolo_model.trt
输入源: camera
置信度阈值: 0.5
NMS 阈值: 0.4
保存结果: 是
输出目录: results
显示统计: 是
========================
初始化 YOLO 检测器...
YOLO 检测器初始化完成
初始化相机...
相机初始化完成
开始测试... (按 'q' 退出)

=== 测试完成 ===
总帧数: 120
平均 FPS: 28.5
平均处理时间: 35.1 ms
================
```

### 9.2 结果文件示例 (detections_0.txt)

```
# Detection results
# Processing time: 32.5 ms
# Objects detected: 2
# Format: class_id confidence x y width height class_name
0 0.95 120 80 60 60 luoshuan
1 0.88 240 120 45 45 daoxian
```

## 10. 总结

本测试程序提供了一个全面的框架，用于评估 YOLO 目标检测器的性能。通过不同场景的测试，可以：

1. **评估性能**：了解检测器在不同条件下的表现
2. **识别问题**：发现检测器的弱点和局限性
3. **优化配置**：根据测试结果调整参数和模型
4. **验证集成**：确保检测器与系统的其他部分正确集成

通过定期运行测试，可以跟踪检测器性能的变化，确保系统在不同条件下都能稳定运行。
